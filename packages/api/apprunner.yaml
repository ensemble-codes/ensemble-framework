version: 1.0
runtime: nodejs18
build:
  commands:
    pre-build:
      # Install pnpm globally
      - npm install -g pnpm
      # Get to repository root using absolute path resolution
      - export REPO_ROOT=$(pwd)/../../
      - cd $REPO_ROOT
      # Install all workspace dependencies
      - pnpm install --frozen-lockfile
    build:
      # Set repository root path
      - export REPO_ROOT=$(pwd)/../../
      # Build SDK package first (required dependency)
      - cd $REPO_ROOT/packages/sdk
      - pnpm build
      # Build API package
      - cd $REPO_ROOT/packages/api  
      - pnpm build
run:
  runtime-version: 18
  command: node dist/index.js
  network:
    port: 3000
    env: PORT
  env:
    # Production environment
    - name: NODE_ENV
      value: production
    
    # These should be set via App Runner environment variables in AWS Console
    # Do not put actual secrets in this file
    - name: JWT_SECRET
      value: placeholder-set-in-aws-console
    
    - name: NETWORK_RPC_URL
      value: placeholder-set-in-aws-console
    
    - name: AGENT_REGISTRY_ADDRESS
      value: 0xDbF645cC23066cc364C4Db915c78135eE52f11B2
    
    - name: SERVICE_REGISTRY_ADDRESS
      value: 0x3Acbf1Ca047a18bE88E7160738A9B0bB64203244
    
    - name: TASK_REGISTRY_ADDRESS
      value: 0x847fA49b999489fD2780fe2843A7b1608106b49b
    
    - name: ENSEMBLE_SUBGRAPH_URL
      value: https://api.goldsky.com/api/public/project_cmcnps2k01akp01uobifl4bby/subgraphs/ensemble-subgraph/0.0.5/gn